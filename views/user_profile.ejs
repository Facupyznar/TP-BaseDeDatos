<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <title>Perfil de Usuario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>

<header class="header">
    <a class="home-btn" href="/">
        <img src="/imgs/casa3.png" alt="Inicio">
    </a>
</header>

<main class="container">
    <h1 class="center-text">Perfil de <%= user.user_name %></h1>

    <div class="center-text" style="color:var(--muted); margin-bottom:16px;">
        <div><strong>Usuario:</strong> <%= user.user_username %></div>
        <div><strong>Email:</strong> <%= user.user_email %></div>
    </div>

    <!-- Rese√±as/ratings/opiniones desde PG (movies.movie_user JOIN movies.movie) -->
    <h2 class="center-text">Mis calificaciones y opiniones</h2>
    <% if ((reviews || []).length > 0) { %>
        <ul class="review-list">
            <% reviews.forEach(r => {
                const pct = r.rating ? Math.max(0, Math.min(100, Number(r.rating) / 5 * 100)) : 0;
            %>
            <li class="review-item card">
                <div class="review-title">
                    üé¨ <a href="/pelicula/<%= r.movie_id %>?from=person"><%= r.title %></a>
                </div>

                <% if (r.rating) { %>
                    <div class="review-rating" style="display:flex; align-items:center; justify-content:flex-start; gap:.4rem; margin:4px 0;">
                        <span class="stars" aria-hidden="true"><i style="width:<%= pct %>%"></i></span>
                        <span>(<%= r.rating %>/5)</span>
                    </div>
                <% } %>

                <% if (r.opinion) { %>
                    <div class="review-text"><%= r.opinion %></div>
                <% } %>

                <div style="margin-top:8px;">
                    <a class="btn-outline" href="/users/<%= user.user_id %>/movies/<%= r.movie_id %>/edit">Editar</a>
                </div>
            </li>
            <% }) %>
        </ul>
    <% } else { %>
        <p class="center-text">Todav√≠a no calificaste ninguna pel√≠cula.</p>
    <% } %>

    <h2 class="center-text">Pel√≠culas favoritas</h2>
    <% if ((favorites || []).length > 0) { %>
        <ul class="review-list">
            <% favorites.forEach(f => { %>
            <li class="review-item card">
                <div class="review-title">
                    ‚≠ê <a href="/pelicula/<%= f.movie_id %>?from=profile"><%= f.title %></a>
                </div>
            </li>
            <% }) %>
        </ul>
    <% } else { %>
        <p class="center-text">No ten√©s pel√≠culas favoritas todav√≠a.</p>
    <% } %>

    <!-- Timeline visible solo para administradores -->
    <% if (isAdmin) { %>
    <section class="timeline">
        <h2>Actividad reciente del usuario</h2>

        <% if ((activities || []).length === 0) { %>
            <p>Sin actividad registrada todav√≠a.</p>
        <% } else { %>
            <ul class="activity-list">
                <% activities.forEach(a => { %>
                    <li class="activity-item">
                        <% if (a.type === 'RATED_MOVIE') { %>
                            üé¨ Calific√≥ la pel√≠cula 
                            <a href="/pelicula/<%= a.details.movieId %>?from=profile"><strong><%= a.details.movieTitle %></strong></a> 
                            con <%= a.details.rating %> ‚≠ê
                        <% } else if (a.type === 'WROTE_REVIEW') { %>
                            ‚úçÔ∏è Escribi√≥ una rese√±a sobre 
                            <a href="/pelicula/<%= a.details.movieId %>?from=profile"><strong><%= a.details.movieTitle %></strong></a>
                        <% } else if (a.type === 'ADDED_TO_FAVORITES') { %>
                            ‚≠ê A√±adi√≥ 
                            <a href="/pelicula/<%= a.details.movieId %>?from=profile"><strong><%= a.details.movieTitle %></strong></a> 
                            a sus favoritos
                        <% } %>
                        <br>
                        <small class="timestamp"><%= new Date(a.timestamp).toLocaleString() %></small>
                    </li>
                <% }) %>
            </ul>
        <% } %>
    </section>
    <% } %>

    <% if (isAdmin){ %>
        <div class="center-text" style="margin-top:18px;">
            <a class="btn" href="/users">‚Üê Volver a la lista de usuarios</a>
        </div>
    <% } %>
</main>

</body>
</html>
