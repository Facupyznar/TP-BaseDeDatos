<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <title><%= movie.title %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>

<header class="header">
    <!-- Casa pequeña -->
    <a class="home-btn" href="/">
        <img src="/imgs/casa3.png" alt="Inicio">
    </a>
</header>

<main class="container">
    <div class="title-row">
        <h1 class="movie-title"><%= movie.title %></h1>

        <% if (typeof average_rating !== 'undefined' && average_rating !== null) {
            const pct = Math.max(0, Math.min(100, Number(average_rating) / 5 * 100));
        %>
        <div class="title-rating">
            <span class="stars" aria-hidden="true"><i style="width:<%= pct %>%"></i></span>
            <span class="avg-num">(<%= average_rating %>/5)</span>
        </div>
        <% } %>
    </div>

    <h3 class="center-text">Fecha:</h3>
    <p class="center-text"><%= movie.release_date ? new Date(movie.release_date).toLocaleDateString() : '—' %></p>

    <h3 class="center-text">Géneros:</h3>
    <ul class="center-text">
        <% (movie.genres || []).forEach(g => { %>
            <li><%= g %></li>
        <% }) %>
        <% if (!movie.genres || !movie.genres.length) { %><li>—</li><% } %>
    </ul>

    <h3 class="center-text">Idioma(s):</h3>
    <ul class="center-text">
        <% (movie.languages || []).forEach(l => { %><li><%= l %></li><% }) %>
        <% if (!movie.languages || !movie.languages.length) { %><li>—</li><% } %>
    </ul>

    <h3 class="center-text">País(es):</h3>
    <ul class="center-text">
        <% (movie.countries || []).forEach(c => { %><li><%= c %></li><% }) %>
        <% if (!movie.countries || !movie.countries.length) { %><li>—</li><% } %>
    </ul>

    <h3 class="center-text">Dirigida por:</h3>
    <ul class="center-text">
        <% (movie.directors || []).forEach(d => { %>
            <li><a href="/director/<%= d.crew_member_id %>?from=movie"><%= d.crew_member_name %></a></li>
        <% }) %>
        <% if (!movie.directors || !movie.directors.length) { %><li>—</li><% } %>
    </ul>

    <h3 class="center-text">Escrita por:</h3>
    <ul class="center-text">
        <% (movie.writers || []).forEach(w => { %>
            <li><%= w.crew_member_name %></li>
        <% }) %>
        <% if (!movie.writers || !movie.writers.length) { %><li>—</li><% } %>
    </ul>

    <h3 class="center-text">Argumento:</h3>
    <div id="overview" class="center-text">
        <p><%= movie.overview || '—' %></p>
    </div>

    <h3 class="center-text">Elenco:</h3>
    <ul class="center-text">
        <% (movie.cast || [])
                .sort((a,b)=>(a.cast_order ?? 999)-(b.cast_order ?? 999))
        .forEach(a => { %>
            <li>
                <a href="/actor/<%= a.actor_id %>?from=movie"><%= a.actor_name %></a>
                <% if (a.character_name) { %> — <em><%= a.character_name %></em><% } %>
            </li>
        <% }) %>
        <% if (!movie.cast || !movie.cast.length) { %><li>—</li><% } %>
    </ul>

    <!-- === BOTÓN DE FAVORITOS === -->
    <% if (user) { %>
        <div class="center-text" style="margin-top:15px;">
            <button 
                id="favorite-btn"
                class="favorite-btn <%= movie.is_favorite ? 'favorited' : '' %>"
                data-userid="<%= user.id %>"
                data-movieid="<%= movie.movie_id %>">
                <span id="fav-icon">⭐</span>
                <span id="fav-text"><%= movie.is_favorite ? 'Quitar de favoritos' : 'Añadir a favoritos' %></span>
            </button>
        </div>
    <% } %>
    <!-- === FIN BOTÓN DE FAVORITOS === -->


    <% if (user) { %>
        <div class="review-section">
            <h3 class="center-text">Tu reseña</h3>

            <form class="review-form" action="/users/<%= user.id %>/movies/<%= movie.movie_id %>/review" method="post" style="text-align:center">
                <!-- Estrellas 1..5 -->
                <div class="star-rating" aria-label="Puntaje">
                    <% for (let i = 5; i >= 1; i--) { %>
                        <input type="radio" id="rate-<%= i %>" name="rating" value="<%= i %>" required>
                        <label for="rate-<%= i %>" title="<%= i %> estrella<%= i>1?'s':'' %>">★</label>
                    <% } %>
                </div>

                <div style="margin-top:10px;">
                    <textarea name="opinion" rows="4" placeholder="Escribí tu opinión…" required style="width:min(640px,96%);"></textarea>
                </div>

                <div style="margin-top:10px;">
                    <button type="submit" class="btn">Publicar</button>
                    <a class="btn-outline" href="/users/<%= user.id %>/movies/<%= movie.movie_id %>/edit">Editar mi reseña</a>
                </div>
            </form>
        </div>
    <% } %>

    <div id="inicio" class="center-text"><a href="/">Inicio</a></div>
</main>

<!-- === SCRIPT PARA FAVORITOS === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('favorite-btn');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    const userId = btn.dataset.userid;
    const movieId = btn.dataset.movieid;

    try {
      const res = await fetch(`/users/${userId}/movies/${movieId}/favorite`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const data = await res.json();

      if (data.success) {
        if (data.action === 'ADDED') {
          btn.classList.add('favorited');
          document.getElementById('fav-text').textContent = 'Quitar de favoritos';
        } else {
          btn.classList.remove('favorited');
          document.getElementById('fav-text').textContent = 'Añadir a favoritos';
        }
      } else {
        alert('Error al modificar favoritos');
      }
    } catch (err) {
      console.error('Error:', err);
      alert('No se pudo actualizar el estado de favorito');
    }
  });
});
</script>
<!-- === FIN SCRIPT === -->

</body>
</html>
